name: Deploy to SpaceWeb via FTP
on:
  push:
    branches:
      - main
jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Ensure public_html exists
        run: mkdir -p public_html
      - name: Generate sitemap.xml
        env:
          SITE_URL: ${{ secrets.SITE_URL }}
        run: |
          mkdir -p public_html
          echo '<?xml version="1.0" encoding="UTF-8"?>' > public_html/sitemap.xml
          echo '<urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">' >> public_html/sitemap.xml
          if [ -d public_html/article ]; then
            find public_html/article -type f -name index.html | sort | while read -r file; do
              rel="${file#public_html/}"
              url="${SITE_URL}/${rel%index.html}"
              echo "  <url><loc>${url}</loc></url>" >> public_html/sitemap.xml
            done
          fi
          echo '</urlset>' >> public_html/sitemap.xml
      - name: Create robots.txt
        env:
          SITE_URL: ${{ secrets.SITE_URL }}
        run: |
          cat > public_html/robots.txt <<EOF
User-agent: *
Disallow:
Sitemap: ${SITE_URL}/sitemap.xml
EOF
      - name: Install lftp
        run: |
          sudo apt-get update -y
          sudo apt-get install -y lftp

      - name: Upload to SpaceWeb FTP
        env:
          FTP_SERVER: ${{ secrets.FTP_SERVER }}
          FTP_PORT: ${{ secrets.FTP_PORT }}
          FTP_USER: ${{ secrets.FTP_USER }}
          FTP_PASSWORD: ${{ secrets.FTP_PASSWORD }}
          FTP_TARGET: ${{ secrets.FTP_TARGET }}
        run: |
          lftp -u "$FTP_USER","$FTP_PASSWORD" -p "$FTP_PORT" "$FTP_SERVER" <<EOF
          set ftp:passive-mode yes
          set ftp:ssl-allow no
          mirror -R public_html $FTP_TARGET
          bye
EOF
